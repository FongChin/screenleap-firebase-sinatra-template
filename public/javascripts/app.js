// Generated by CoffeeScript 1.3.3
(function() {
  var alertExtensionIsDisabled, alertMsg, checkIsScreenSharing, clearMsg, exports, extensionInUse, initiateScreenShare, installExtension, makeScreenShareRequest;

  exports = this;

  exports.data = {};

  exports.data.roomDataRef = new Firebase(firebaseURL + roomId);

  exports.data.isPublisher = false;

  exports.data.screenIsSharing = false;

  window.onload = function() {
    screenleap.screenShareStarted = function() {
      return alertMsg("Your screen is now shared.");
    };
    return screenleap.screenShareEnded = function() {
      return exports.data.roomDataRef.remove();
    };
  };

  window.onbeforeunload = function(e) {
    e = e || window.event;
    if (e && exports.data.isPublisher && exports.data.screenIsSharing) {
      return screenleap.stopSharing();
    }
  };

  alertMsg = function(html) {
    $("#alertMsgDiv").html("");
    $("#alertMsgDiv").html(html);
    $("#alertMsgDiv").css({
      display: "block"
    });
    return exports.data.interval = setInterval(clearMsg, 4000);
  };

  clearMsg = function() {
    $("#alertMsgDiv").html("");
    return clearInterval(exports.data.interval);
  };

  exports.data.roomDataRef.on("child_added", function(snapshot) {
    var iframeHtml;
    exports.data.screenIsSharing = true;
    $("#shareButtonContainer").css({
      display: "none"
    });
    if (exports.data.isPublisher) {
      $("#stopButtonContainer").css({
        display: "block"
      });
    }
    iframeHtml = "<iframe src=\"" + (snapshot.val().viewerUrl) + "\" width=\"800px\" height=\"700px\">\n  <p>Your browser does not support iframes.</p>\n</iframe>";
    if (exports.data.isPublisher) {
      return $("#iframeDiv").html("<h4>You are sharing screen now!</h4>");
    } else {
      return $("#iframeDiv").html(iframeHtml);
    }
  });

  exports.data.roomDataRef.on("child_removed", function(snapshot) {
    $("#iframeDiv").html("");
    $("#stopButtonContainer").css({
      display: "none"
    });
    $("#shareButtonContainer").css({
      display: "block"
    });
    alertMsg("Screen share ended");
    exports.data.screenIsSharing = false;
    return exports.data.isPublisher = false;
  });

  makeScreenShareRequest = function() {
    return $.post("/screenleap", function(res) {
      var screenShareData;
      screenShareData = JSON.parse(res);
      exports.data.isPublisher = true;
      exports.data.roomDataRef.onDisconnect().remove();
      $("#shareButtonContainer").css({
        display: "none"
      });
      screenleap.startSharing("EXTENSION", screenShareData);
      $("#stopButtonContainer").css({
        display: "block"
      });
      return exports.data.roomDataRef.push().set({
        viewerUrl: screenShareData.viewerUrl
      });
    });
  };

  extensionInUse = function() {
    return alertMsg("Your screenleap extension is in use.");
  };

  checkIsScreenSharing = function() {
    return screenleap.checkIsSharing(extensionInUse, makeScreenShareRequest, "EXTENSION");
  };

  alertExtensionIsDisabled = function() {
    return alertMsg("Your screenleap extension is installed but not enabled. Please enable to share screen.");
  };

  initiateScreenShare = function() {
    return screenleap.checkIsExtensionEnabled(checkIsScreenSharing, alertExtensionIsDisabled);
  };

  installExtension = function() {
    return screenleap.installExtension(makeScreenShareRequest, function() {});
  };

  $("#startScreenSharebtn").click(function() {
    return screenleap.checkIsExtensionInstalled(initiateScreenShare, installExtension);
  });

  $("#stopScreenSharebtn").bind("click", function() {
    return screenleap.stopSharing();
  });

}).call(this);
